<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reconocimiento Facial</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .video-feed {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .log-item {
            background: #fff;
            border-left: 4px solid #007bff;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .recognition-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
        }
        
        .fps-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .btn-register {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-register:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-camera-retro me-2"></i>
                Sistema de Reconocimiento Facial
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span class="status-indicator status-online"></span>
                    Sistema Activo
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Columna principal - Video y controles -->
            <div class="col-lg-8">
                <!-- Stream de video en vivo -->
                <div class="video-container mb-4">
                    <img id="videoFeed" src="/video_feed" alt="Stream en vivo" class="video-feed">
                    <div class="recognition-status">
                        <i class="fas fa-eye me-2"></i>
                        <span id="recognitionStatus">Esperando rostros...</span>
                    </div>
                    <div class="fps-indicator">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        <span id="fpsIndicator">0 FPS</span>
                    </div>
                </div>

                <!-- Panel de control -->
                <div class="control-panel">
                    <h5><i class="fas fa-sliders-h me-2"></i>Panel de Control</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-register w-100 mb-3" data-bs-toggle="modal" data-bs-target="#registerModal">
                                <i class="fas fa-user-plus me-2"></i>Registrar Nueva Persona
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary w-100 mb-3" onclick="refreshStats()">
                                <i class="fas fa-sync-alt me-2"></i>Actualizar Estadísticas
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-outline-warning w-100 mb-3" onclick="restartCamera()">
                                <i class="fas fa-redo me-2"></i>Reiniciar Cámara
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-info w-100 mb-3" onclick="clearLogs()">
                                <i class="fas fa-trash me-2"></i>Limpiar Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna lateral - Estadísticas y logs -->
            <div class="col-lg-4">
                <!-- Estadísticas del sistema -->
                <div class="stats-card">
                    <h5><i class="fas fa-chart-bar me-2"></i>Estadísticas del Sistema</h5>
                    <div class="row text-center">
                        <div class="col-6">
                            <h3 id="peopleCount">{{ people_count }}</h3>
                            <small>Personas Registradas</small>
                        </div>
                        <div class="col-6">
                            <h3 id="fpsCount">0</h3>
                            <small>FPS Actual</small>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <h3 id="recognitionCount">0</h3>
                            <small>Reconocimientos</small>
                        </div>
                        <div class="col-6">
                            <h3 id="uptimeCount">0s</h3>
                            <small>Tiempo Activo</small>
                        </div>
                    </div>
                </div>

                <!-- Logs recientes -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-history me-2"></i>Logs Recientes</h6>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="logsContainer">
                            {% for log in recent_logs %}
                            <div class="log-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">{{ log[0] or "Desconocido" }}</span>
                                    <small class="text-muted">{{ log[1] }}</small>
                                </div>
                                <div class="text-muted">
                                    Confianza: {{ "%.2f"|format(log[2]) }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para registrar persona -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Nueva Persona</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="personName" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="personName" required>
                        </div>
                        <div class="mb-3">
                            <label for="personImage" class="form-label">Imagen del rostro</label>
                            <input type="file" class="form-control" id="personImage" accept="image/*" required>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            La imagen debe mostrar claramente el rostro de la persona a registrar.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="registerPerson()">Registrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let startTime = Date.now();
        let recognitionCount = 0;

        // Actualizar estadísticas cada 2 segundos
        setInterval(updateStats, 2000);

        // Actualizar logs cada 5 segundos
        setInterval(updateLogs, 5000);

        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    // Actualizar FPS
                    if (data.camera && data.camera.current_fps) {
                        document.getElementById('fpsCount').textContent = Math.round(data.camera.current_fps);
                        document.getElementById('fpsIndicator').textContent = Math.round(data.camera.current_fps) + ' FPS';
                    }

                    // Actualizar tiempo activo
                    const uptime = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('uptimeCount').textContent = uptime + 's';

                    // Actualizar contador de reconocimientos
                    if (data.recognition && data.recognition.total_recent) {
                        document.getElementById('recognitionCount').textContent = data.recognition.total_recent;
                    }

                    // Actualizar estado de reconocimiento
                    if (data.recognition && data.recognition.total_recent > 0) {
                        document.getElementById('recognitionStatus').textContent = 'Rostros detectados';
                    } else {
                        document.getElementById('recognitionStatus').textContent = 'Esperando rostros...';
                    }
                })
                .catch(error => console.error('Error al obtener estadísticas:', error));
        }

        function updateLogs() {
            fetch('/api/logs?limit=10')
                .then(response => response.json())
                .then(data => {
                    const logsContainer = document.getElementById('logsContainer');
                    logsContainer.innerHTML = '';

                    data.logs.forEach(log => {
                        const logItem = document.createElement('div');
                        logItem.className = 'log-item';
                        logItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">${log[0] || 'Desconocido'}</span>
                                <small class="text-muted">${log[1]}</small>
                            </div>
                            <div class="text-muted">
                                Confianza: ${log[2].toFixed(2)}
                            </div>
                        `;
                        logsContainer.appendChild(logItem);
                    });
                })
                .catch(error => console.error('Error al obtener logs:', error));
        }

        function refreshStats() {
            updateStats();
            updateLogs();
        }

        function restartCamera() {
            if (confirm('¿Estás seguro de que quieres reiniciar la cámara?')) {
                fetch('/api/camera/restart', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        setTimeout(() => location.reload(), 2000);
                    })
                    .catch(error => {
                        alert('Error al reiniciar la cámara: ' + error);
                    });
            }
        }

        function clearLogs() {
            if (confirm('¿Estás seguro de que quieres limpiar los logs?')) {
                // Aquí se implementaría la limpieza de logs
                alert('Función de limpieza de logs en desarrollo');
            }
        }

        function registerPerson() {
            const name = document.getElementById('personName').value;
            const imageFile = document.getElementById('personImage').files[0];

            if (!name || !imageFile) {
                alert('Por favor completa todos los campos');
                return;
            }

            // Aquí se implementaría el registro de la persona
            // Por ahora solo simulamos
            alert(`Persona ${name} registrada exitosamente (simulado)`);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
            modal.hide();
            
            // Limpiar formulario
            document.getElementById('registerForm').reset();
        }

        // Inicializar estadísticas
        updateStats();
    </script>
</body>
</html> 